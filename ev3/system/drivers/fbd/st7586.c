#include <stdint.h>
#include <stdio.h>
#include <stdarg.h>
#include <ewoksys/proc.h>

/* controller-specific commands */
#define ST7586_DISP_MODE_GRAY   0x38
#define ST7586_DISP_MODE_MONO   0x39
#define ST7586_ENABLE_DDRAM 0x3a
#define ST7586_SET_DISP_DUTY    0xb0
#define ST7586_SET_PART_DISP    0xb4
#define ST7586_SET_NLINE_INV    0xb5
#define ST7586_SET_VOP      0xc0
#define ST7586_SET_BIAS_SYSTEM  0xc3
#define ST7586_SET_BOOST_LEVEL  0xc4
#define ST7586_SET_VOP_OFFSET   0xc7
#define ST7586_ENABLE_ANALOG    0xd0
#define ST7586_AUTO_READ_CTRL   0xd7
#define ST7586_OTP_RW_CTRL  0xe0
#define ST7586_OTP_CTRL_OUT 0xe1
#define ST7586_OTP_READ     0xe3

#define ST7586_DISP_CTRL_MX BIT(6)
#define ST7586_DISP_CTRL_MY BIT(7)

#include "arch/ev3/spi.h"
#include "bsp/bsp_gpio.h"

#define RESET_PIN	(80)
#define CMD_PIN		(43)
#define CS_PIN		(44)


static void msleep(int ms){
	proc_usleep(ms * 1000);
}

static void st7586_command0(uint8_t cmd){
	bsp_gpio_write(CS_PIN, 0);
	bsp_gpio_write(CMD_PIN, 0);
	davinci_spi_write(1, &cmd, SPI_XFER_END);
	bsp_gpio_write(CMD_PIN, 1);
	bsp_gpio_write(CS_PIN, 1);
}


static void st7586_command1(uint8_t cmd, uint8_t data0){
	bsp_gpio_write(CMD_PIN, 0);
	bsp_gpio_write(CS_PIN, 0);
	davinci_spi_write(1, &cmd, 0);
	bsp_gpio_write(CMD_PIN, 1);
	davinci_spi_write(1, &data0, SPI_XFER_END);
	bsp_gpio_write(CS_PIN, 1);
}

static void st7586_command2(uint8_t cmd, uint8_t data0, uint8_t data1){
	uint8_t data[2] = {data0, data1};
	bsp_gpio_write(CMD_PIN, 0);
	bsp_gpio_write(CS_PIN, 0);
	davinci_spi_write(1, &cmd, 0);
	bsp_gpio_write(CMD_PIN, 1);
	davinci_spi_write(2, data, SPI_XFER_END);
	bsp_gpio_write(CS_PIN, 1);
}

static void st7586_command4(uint8_t cmd, uint8_t data0, uint8_t data1, uint8_t data2, uint8_t data3){
	uint8_t data[4] = {data0, data1, data2, data3};
	bsp_gpio_write(CMD_PIN, 0);
	bsp_gpio_write(CS_PIN, 0);
	davinci_spi_write(1, &cmd, 0);
	bsp_gpio_write(CMD_PIN, 1);
	davinci_spi_write(4, data, SPI_XFER_END);
	bsp_gpio_write(CS_PIN, 1);
}

static const uint8_t lookup_tb_1[] = {
	0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
	0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
	0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
	0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t lookup_tb_2[] = {
	0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c,
	0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c,
	0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c,
	0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c, 0x1c,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t lookup_tb_3[] = {
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

void st7586_update(uint8_t* buf, int width, int height){
	uint8_t cmd = 0x2C;
	uint8_t val;
	int w = ((width) / 3);
	st7586_command4(0x2B, 0, 0, height>>8, height&0xFF);
    st7586_command4(0x2A, 0, 0, w>>8, w&0xFF);

	bsp_gpio_write(CS_PIN, 0);
	bsp_gpio_write(CMD_PIN, 0);
	davinci_spi_write(1, &cmd, 0);
	bsp_gpio_write(CMD_PIN, 1);
	for(int i = 0; i < height; i++){
		uint8_t *p = &buf[i*width];
		for(int j = 0; j < width; j+=3){
			val = lookup_tb_1[*p++];
			val |= lookup_tb_2[*p++];
			val |= lookup_tb_3[*p++];
			davinci_spi_write(1, &val, 0);
		}
	}
	bsp_gpio_write(CS_PIN, 1);
}

void st7586_init(void)
{
	bsp_gpio_init();
	davinci_spi_init(1);

//	bsp_gpio_config(RESET_PIN, GPIO_OUTPUT);
	bsp_gpio_config(CMD_PIN, GPIO_OUTPUT);
	bsp_gpio_config(CS_PIN, GPIO_OUTPUT);
	

	msleep(20);
	bsp_gpio_write(RESET_PIN, 1);
	bsp_gpio_write(CMD_PIN, 1);
	msleep(20);

	//davinci_spi_claim_bus(0);

    st7586_command1(ST7586_AUTO_READ_CTRL, 0x9f);
    st7586_command1(ST7586_OTP_RW_CTRL, 0x00);

    msleep(10);

    st7586_command0(ST7586_OTP_READ);

    msleep(20);

    st7586_command0(ST7586_OTP_CTRL_OUT);

    msleep(50);

    st7586_command1(ST7586_SET_VOP_OFFSET, 0x00);
    st7586_command2(ST7586_SET_VOP, 0xe3, 0x00);
    st7586_command1(ST7586_SET_BIAS_SYSTEM, 0x02);
    st7586_command1(ST7586_SET_BOOST_LEVEL, 0x04);
    st7586_command1(ST7586_ENABLE_ANALOG, 0x1d);
    st7586_command1(ST7586_SET_NLINE_INV, 0x00);
    st7586_command0(ST7586_DISP_MODE_GRAY);
	st7586_command1(ST7586_ENABLE_DDRAM, 0x02);

    st7586_command1(ST7586_SET_DISP_DUTY, 0x7f);
    st7586_command1(ST7586_SET_PART_DISP, 0xa0);
}
